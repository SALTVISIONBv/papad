<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Papadatos 3D Configurator</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
	
    <!-- Fullscreen styling -->
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000000;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      }
      
      #unity-container {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      
      #unity-canvas {
        background: #e6e4dd;
        display: block;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
      }
      
      #unity-loading-bar {
        display: none !important;
      }
      
      #unity-logo {
        display: none !important;
      }
      
      #unity-progress-bar-empty,
      #unity-progress-bar-full {
        display: none !important;
      }
      
      #unity-warning {
        position: absolute;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
      }

      /* Beautiful Custom Loading Screen */
      #custom-loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #000000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: background 1s ease-out, opacity 0.5s ease-out, visibility 0.5s ease-out;
      }
      
      #custom-loading-screen.hidden {
        opacity: 0;
        visibility: hidden;
      }
      
      .loading-content {
        text-align: center;
        width: 90%;
        max-width: 1000px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        padding: 20px;
        box-sizing: border-box;
      }
      
      .logo-container {
        margin-bottom: 4vh;
        text-align: center;
      }
      
      .logo-container img {
        max-width: 300px;
        height: auto;
        transition: filter 1s ease-out;
      }
      
      .progress-section {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      .progress-container {
        width: 150px;
        max-width: 80%;
        height: 2px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        margin-left: auto;
        margin-right: auto;
        position: relative;
        overflow: visible;
      }
      
      @media (max-width: 768px) {
        .progress-container {
          width: 160px;
          max-width: 75%;
        }
      }

      .progress-line {
        height: 6px;
        background: #ffffff;
        width: 0%;
        transition: width 0.3s ease-out, background 1s ease-out;
      }

      .progress-line-middle {
        height: 2px;
        background: #000000;
        width: 100%;
        transition: width 0.3s ease-out, background 1s ease-out;
      }

      .progress-line.left {
        margin-right: 0;
      }

      .progress-line.right {
        margin-left: 0;
      }

      #custom-loading-screen.progress-60 {
        background: #555555;
      }

      #custom-loading-screen.progress-60 .progress-line {
        background: #f0f0f0;
      }

      #custom-loading-screen.progress-60 .progress-line-middle {
        background: #555555;
      }

      #custom-loading-screen.progress-60 .tagline,
      #custom-loading-screen.progress-60 .progress-text {
        color: #f0f0f0;
      }

      #custom-loading-screen.progress-75 {
        background: #aaaaaa;
      }

      #custom-loading-screen.progress-75 .progress-line {
        background: #333333;
      }

      #custom-loading-screen.progress-75 .progress-line-middle {
        background: #aaaaaa;
      }

      #custom-loading-screen.progress-75 .tagline,
      #custom-loading-screen.progress-75 .progress-text {
        color: #333333;
      }

      #custom-loading-screen.progress-100 {
        background: #ffffff;
      }

      #custom-loading-screen.progress-100 .progress-line {
        background: #000000;
        width: 50%;
      }

      #custom-loading-screen.progress-100 .progress-line-middle {
        width: 0%;
        background: transparent;
      }

      #custom-loading-screen.progress-100 .tagline,
      #custom-loading-screen.progress-100 .progress-text {
        color: #000000;
      }
      
      .tagline {
        color: #ffffff;
        font-size: 1.4rem;
        font-weight: 200;
        margin-bottom: 30px;
        transition: color 1s ease-out;
      }
      
      .progress-text {
        font-size: 3.2rem;
        color: #ffffff;
        font-weight: 300;
        margin-top: 20px;
        transition: color 1s ease-out;
      }
      
      .waiting-text {
        font-size: 0.9rem;
        color: #ffffff;
        font-weight: 300;
        margin-top: 15px;
        opacity: 0;
        transition: color 1s ease-out, opacity 0.8s ease-in-out;
      }
      
      .waiting-text.visible {
        opacity: 1;
        animation: blink 2s ease-in-out infinite;
      }
      
      @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
      }
      
      #custom-loading-screen.progress-60 .waiting-text {
        color: #f0f0f0;
      }
      
      #custom-loading-screen.progress-75 .waiting-text {
        color: #333333;
      }
      
      #custom-loading-screen.progress-100 .waiting-text {
        color: #000000;
      }
      
      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .logo-container img {
          max-width: 200px;
        }
        
        .tagline {
          font-size: 1.2rem;
        }
        
        .progress-text {
          font-size: 2.5rem;
        }
        
        .waiting-text {
          font-size: 0.8rem;
        }
        
        .loading-content {
          width: 85%;
          padding: 15px;
        }
      }
      
      /* Portrait orientation - extra adjustments */
      @media (max-width: 768px) and (orientation: portrait) {
        .logo-container {
          margin-bottom: 3vh;
        }
        
        .logo-container img {
          max-width: 180px;
        }
      }
      
      /* Landscape orientation - compact vertical spacing */
      @media (max-height: 500px) and (orientation: landscape) {
        .loading-content {
          padding: 10px;
        }
        
        .logo-container {
          margin-bottom: 2vh;
        }
        
        .logo-container img {
          max-width: 150px;
        }
        
        .tagline {
          font-size: 1rem;
          margin-bottom: 15px;
        }
        
        .progress-text {
          font-size: 2rem;
          margin-top: 10px;
        }
        
        .waiting-text {
          font-size: 0.7rem;
          margin-top: 10px;
        }
      }
    </style>
    
    <!-- PlayerPrefs fix -->
    <script>
      (function() {
        var promiseLocalStorage = {
          _data: {},
          getItem: function(key) { 
            return this._data[key] || null; 
          },
          setItem: function(key, value) { 
            this._data[key] = String(value); 
            return value;
          },
          removeItem: function(key) { 
            delete this._data[key]; 
          },
          clear: function() { 
            this._data = {}; 
          },
          then: function(callback) { 
            callback(this);
            return this;
          },
          catch: function(callback) { 
            return this;
          }
        };

        window.getUserConfig = function() { return promiseLocalStorage; };
        window._GetUserConfig = function() { return promiseLocalStorage; };
        window.GetUserConfig = function() { return promiseLocalStorage; };
        window.testUserConfigStorage = function() { return promiseLocalStorage; };
        
        try {
          window.localStorage.getItem("test");
        } catch (e) {
          window.localStorage = promiseLocalStorage;
        }
        
        console.log("PlayerPrefs polyfill installed");
      })();
      
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            registration.unregister();
            console.log('ServiceWorker unregistered');
          }
        });
      }
    </script>
  </head>
  <body>
    <!-- Custom Loading Screen -->
    <div id="custom-loading-screen">
      <div class="loading-content">
        <div class="logo-container">
          <img src="Papadatos_logo_white.png" alt="Papadatos Logo" id="logo-image">
        </div>
        
        <div class="progress-section">
          <div class="progress-container">
            <div class="progress-line left"></div>
            <div class="progress-line-middle"></div>
            <div class="progress-line right"></div>
          </div>
          <div class="tagline">Configure Your Vision</div>
          <div class="progress-text" id="progress-text">%00</div>
          <div class="waiting-text" id="waiting-text">Please wait until the loading completes...</div>
        </div>
      </div>
    </div>

    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
    </div>
    
    <!-- Main Unity Loading Script -->
    <script>
      // Set template ready flag
      window.templateReady = true;
      
      // Get DOM elements
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var customLoadingScreen = document.querySelector("#custom-loading-screen");
      var progressText = document.querySelector("#progress-text");
      var waitingText = document.querySelector("#waiting-text");
      var progressLineLeft = document.querySelector(".progress-line.left");
      var progressLineRight = document.querySelector(".progress-line.right");
      var progressLineMiddle = document.querySelector(".progress-line-middle");
      var logoImage = document.getElementById('logo-image');

      // Unity configuration
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/WebGL_Build.loader.js";
      var config = {
        dataUrl: buildUrl + "/WebGL_Build.data",
        frameworkUrl: buildUrl + "/WebGL_Build.framework.js",
        codeUrl: buildUrl + "/WebGL_Build.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Papadatos",
        productName: "3D Configurator",
        productVersion: "1.0",
        showBanner: false,
      };

      // iOS Memory Limiting
      var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      var isAndroid = /Android/i.test(navigator.userAgent);

      if (isIOS) {
        console.log("üçé iOS Device Detected");
        config.memorySize = 320;
        console.log("   ‚úÖ Memory limit set to 320MB");
        config.devicePixelRatio = 1;
        console.log("   ‚úÖ Device pixel ratio set to 1");
        console.log("   ‚ö†Ô∏è iOS Safari has strict memory limits:");
        console.log("   ‚Ä¢ Apps killed at ~400MB (no warning)");
        console.log("   ‚Ä¢ No SharedArrayBuffer support");
        console.log("   ‚Ä¢ Background tabs may be suspended");
        console.log("   ‚Ä¢ Expect longer load times vs desktop");
        console.log("   ‚Ä¢ performance.memory API not available");
        
        config.streamingAssetsUrl = config.streamingAssetsUrl || "StreamingAssets";
        
        window.unityMemoryError = false;
        window.addEventListener('error', function(event) {
          if (event.message && (event.message.includes('memory') || event.message.includes('undefined'))) {
            window.unityMemoryError = true;
            console.error("üî¥ Unity memory error detected on iOS");
            console.error("   This usually means memory limit exceeded");
            console.error("   Try reducing quality settings or model count");
          }
        });
      }
      
      // Mobile detection
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        container.className = "unity-mobile";
      }

      // Performance Monitoring
      var unityStartTime = Date.now();

      if (performance && performance.memory && !isIOS) {
        console.log("üìä Memory monitoring enabled");
        
        setInterval(function() {
          try {
            if (!performance.memory || !performance.memory.usedJSHeapSize) {
              return;
            }
            
            var memUsed = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
            var memLimit = (performance.memory.jsHeapSizeLimit / 1048576).toFixed(1);
            var memPercent = ((performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit) * 100).toFixed(1);
            
            console.log(`üìä Memory: ${memUsed}MB / ${memLimit}MB (${memPercent}%)`);
            
            if (memPercent > 80) {
              console.warn(`‚ö†Ô∏è Memory usage at ${memPercent}%`);
            }
          } catch (e) {
            console.error("‚ùå Error reading memory:", e.message);
          }
        }, 10000);
      } else if (isIOS) {
        console.log("üì± iOS detected - memory monitoring not available");
        console.log("   (iOS Safari doesn't support performance.memory)");
      }

      // Update loading screen appearance based on progress
      function updateLoadingScreenProgress(percentage) {
        customLoadingScreen.classList.remove('progress-60', 'progress-75', 'progress-100');
        
        if (percentage >= 100) {
          customLoadingScreen.classList.add('progress-100');
          logoImage.src = "Papadatos_logo_black.png";
        } else if (percentage >= 75) {
          customLoadingScreen.classList.add('progress-75');
          logoImage.src = "Papadatos_logo_black.png";
        } else if (percentage >= 60) {
          customLoadingScreen.classList.add('progress-60');
          logoImage.src = "Papadatos_logo_black.png";
        }
      }

      // Update progress lines
      function updateProgressLines(percentage) {
        if (percentage >= 100) {
          progressLineLeft.style.width = '50%';
          progressLineRight.style.width = '50%';
          progressLineMiddle.style.width = '0%';
          return;
        }
        
        var lineWidth = (percentage / 2) + '%';
        progressLineLeft.style.width = lineWidth;
        progressLineRight.style.width = lineWidth;
        
        var middleWidth = (100 - percentage) + '%';
        progressLineMiddle.style.width = middleWidth;
      }

      // Hide loading screen
      function hideLoadingScreen() {
        customLoadingScreen.classList.add('hidden');
        setTimeout(function() {
          customLoadingScreen.remove();
        }, 500);
      }

      // Mock loading for testing
      function mockLoading() {
        var mockPercentage = 0;
        var mockInterval = setInterval(function() {
          mockPercentage += 1;
          progressText.textContent = "%" + mockPercentage;
          updateLoadingScreenProgress(mockPercentage);
          updateProgressLines(mockPercentage);
          
          if (mockPercentage >= 100) {
            clearInterval(mockInterval);
            setTimeout(hideLoadingScreen, 1000);
          }
        }, 50);
      }

      // Check URL parameters
      var urlParams = new URLSearchParams(window.location.search);
      var useMock = urlParams.get('mock') === 'true';
      
      // ============================================================================
      // MODIFIED: PARALLEL LOADING SYSTEM
      // ============================================================================
      
      var fakeProgress = 0;
      var unityProgress = 0;
      var unityActuallyReady = false;
      var fakeProgressInterval = null;
      var fakeProgressComplete = false;
      
      // Start fake progress animation (0-100% over 5 seconds)
      function startFakeProgress() {
        var startTime = Date.now();
        var duration = 25000;
        
        fakeProgressInterval = setInterval(function() {
          var elapsed = Date.now() - startTime;
          var progress = Math.min((elapsed / duration) * 100, 100);
          
          fakeProgress = progress;
          
          // Display ONLY fake progress (Unity loads in parallel, independently)
          var displayProgress = Math.round(fakeProgress);
          
          progressText.textContent = "%" + displayProgress;
          updateLoadingScreenProgress(displayProgress);
          updateProgressLines(displayProgress);
          
          if (displayProgress % 10 === 0 || displayProgress === 100) {
            console.log("Display progress: " + displayProgress + "% (fake: " + Math.round(fakeProgress) + "%, unity: " + Math.round(unityProgress) + "%)");
          }
          
          if (fakeProgress >= 100) {
            clearInterval(fakeProgressInterval);
            fakeProgressComplete = true;
            console.log("Fake progress complete at 100%");
            checkIfReadyToComplete();
          }
        }, 50);
      }
      
      // Check if we can hide the loading screen
      function checkIfReadyToComplete() {
        if (fakeProgressComplete && unityActuallyReady) {
          console.log("Both fake and Unity loading complete! Hiding loading screen");
          waitingText.classList.remove('visible');
          setTimeout(hideLoadingScreen, 500);
        } else if (fakeProgressComplete && !unityActuallyReady) {
          console.log("Fake loading done at 100%, waiting for Unity to finish...");
          waitingText.classList.add('visible');
          // Just wait - don't loop. Unity will call checkIfReadyToComplete when ready.
        }
      }
      
      if (useMock) {
        console.log("Using mock loading for testing");
        mockLoading();
      } else {
        // START BOTH LOADINGS AT THE SAME TIME
        console.log("Starting parallel loading (fake + Unity)");
        startFakeProgress();
        
        // Load Unity script immediately (not after fake loading)
        var script = document.createElement("script");
        script.src = loaderUrl;
        
        script.onerror = function() {
          console.error("Failed to load Unity loader. Using demo mode.");
          clearInterval(fakeProgressInterval);
          waitingText.classList.remove('visible');
          progressText.textContent = "Using demo mode";
          setTimeout(mockLoading, 1000);
        };
        
        script.onload = function() {
          console.log("Unity loader script loaded, creating instance...");
          createUnityInstance(canvas, config, function(progress) {
            // Update Unity progress (tracked in background, doesn't affect display)
            unityProgress = progress * 100;
            
            var realPercentage = Math.round(progress * 100);
            if (realPercentage % 10 === 0 || realPercentage === 100) {
              console.log("Unity loading: " + realPercentage + "%");
            }
          }).then(function(unityInstance) {
            console.log("Unity instance created successfully!");
            unityActuallyReady = true;
            unityProgress = 100;
            
            checkIfReadyToComplete();
            
            window.unityInstance = unityInstance;
            
            window.addEventListener('error', function(e) {
              if (e.message && e.message.includes('undefined is not an object')) {
                console.warn("‚ö†Ô∏è Caught iOS compatibility error:", e.message);
                console.warn("   This is likely related to memory API not being available");
                console.warn("   App should continue working - monitoring disabled");
                e.preventDefault();
                return false;
              }
            });
            
            window.addEventListener('unhandledrejection', function(e) {
              console.warn("‚ö†Ô∏è Unhandled promise rejection:", e.reason);
              e.preventDefault();
            });
            
            var configId = urlParams.get('id');
            if (configId && unityInstance.SendMessage) {
              console.log("Loading configuration ID: " + configId);
              try {
                unityInstance.SendMessage('SceneManager', 'TestLoadConfiguration', configId);
              } catch (e) {
                console.log("Could not send message to Unity:", e);
              }
            }
          }).catch(function(error) {
            console.error("Unity initialization error:", error);
            clearInterval(fakeProgressInterval);
            waitingText.classList.remove('visible');
            progressText.textContent = "Using demo mode";
            setTimeout(mockLoading, 2000);
          });
        };

        document.body.appendChild(script);
      }

      // Unity callback when models are loaded
      window.onUnityModelsLoaded = function() {
        console.log("All 3D models loaded successfully!");
      };
    </script>

    <!-- Utility Functions -->
    <script>
      // Copy to clipboard
      window.CopyToClipboardJS = function(text) {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text).then(function() {
            console.log('Copied to clipboard');
            if (window.unityInstance && window.unityInstance.SendMessage) {
              try {
                window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardCopySuccess', text);
              } catch (e) {
                console.log('Clipboard callback not found');
              }
            }
          }).catch(function(err) {
            console.error('Clipboard copy failed:', err);
            fallbackCopyTextToClipboard(text);
          });
        } else {
          fallbackCopyTextToClipboard(text);
        }
      };

      function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.top = "0";
        textArea.style.left = "0";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          document.execCommand('copy');
          console.log('Copied using fallback');
          if (window.unityInstance && window.unityInstance.SendMessage) {
            try {
              window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardCopySuccess', text);
            } catch (e) {}
          }
        } catch (err) {
          console.error('Fallback copy failed:', err);
        }

        document.body.removeChild(textArea);
      }

      // Open invoice in new window
      window.OpenInvoiceInNewWindow = function(htmlContent) {
        var newWindow = window.open('', '_blank');
        if (newWindow) {
          newWindow.document.write(htmlContent);
          newWindow.document.close();
          console.log('Invoice opened');
        } else {
          console.error('Popup blocked');
          alert('Please allow popups for this site.');
        }
      };

      // Save screenshot
      window.SaveScreenshot = function(base64Image, fileName) {
        try {
          var byteCharacters = atob(base64Image);
          var byteNumbers = new Array(byteCharacters.length);
          for (var i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          var byteArray = new Uint8Array(byteNumbers);
          var blob = new Blob([byteArray], {type: 'image/png'});

          var link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = fileName + '.png';
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          URL.revokeObjectURL(link.href);
          
          console.log('Screenshot saved:', fileName);
        } catch (error) {
          console.error('Screenshot save error:', error);
        }
      };
    </script>
  </body>
</html>
