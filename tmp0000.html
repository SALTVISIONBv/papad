<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Papadatos 3D Configurator</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    
    <!-- Fullscreen styling -->
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000000;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      }
      
      #unity-container {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      
      #unity-canvas {
        background: #e6e4dd;
        display: block;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
      }
      
      /* Hide the default Unity loading bar */
      #unity-loading-bar {
        display: none !important;
      }
      
      /* Hide Unity logo specifically */
      #unity-logo {
        display: none !important;
      }
      
      /* Hide progress bar too */
      #unity-progress-bar-empty,
      #unity-progress-bar-full {
        display: none !important;
      }
      
      #unity-warning {
        position: absolute;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
      }

      /* Beautiful Custom Loading Screen with Progressive Background */
      #custom-loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        /* Start with pure black background */
        background: #000000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: background 1s ease-out, opacity 0.5s ease-out, visibility 0.5s ease-out;
      }
      
      #custom-loading-screen.hidden {
        opacity: 0;
        visibility: hidden;
      }
      
      .loading-content {
        text-align: center;
        width: 90%;
        max-width: 1000px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        height: 100vh;
      }
      
      .logo-container {
        margin-top: 43vh;
        margin-bottom: 2vh;
        text-align: center;
      }
      
      .logo-container img {
        max-width: 300px;
        height: auto;
        transition: filter 1s ease-out;
      }
      
      .progress-section {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
		.progress-container {
		  width: 150px;
		  max-width: 80%; /* Fallback for very small screens */
		  height: 2px; /* Match the line height */
		  display: flex;
		  justify-content: space-between;
		  align-items: center;
		  margin-bottom: 30px;
		  margin-left: auto;
		  margin-right: auto;
		  position: relative;
		  overflow: visible; /* Allow lines to be visible */
		}
		
		/* Mobile */
		@media (max-width: 768px) {
		  .progress-container {
			width: 160px; /* Slightly smaller than 200px mobile logo */
			max-width: 75%;
		  }
		}


		.progress-line {
		  height: 6px; /* Increased from 1px to 2px */
		  background: #ffffff;
		  width: 0%; /* Start at 0% width */
		  transition: width 0.3s ease-out, background 1s ease-out;
		}

		.progress-line-middle {
		  height: 2px; /* Increased from 1px to 2px */
		  background: #000000;
		  width: 100%; /* Start at full width */
		  transition: width 0.3s ease-out, background 1s ease-out;
		}

		.progress-line.left {
		  margin-right: 0;
		}

		.progress-line.right {
		  margin-left: 0;
		}

		/* Update the progress states for the new design */
		#custom-loading-screen.progress-60 .progress-line {
		  background: #f0f0f0;
		}

		#custom-loading-screen.progress-60 .progress-line-middle {
		  background: #555555;
		}

		#custom-loading-screen.progress-75 .progress-line {
		  background: #333333;
		}

		#custom-loading-screen.progress-75 .progress-line-middle {
		  background: #aaaaaa;
		}

		#custom-loading-screen.progress-100 .progress-line {
		  background: #000000;
		  width: 50%; /* Ensure they're exactly 50% at 100% progress */
		}

		#custom-loading-screen.progress-100 .progress-line-middle {
		  width: 0%; /* Make middle disappear at 100% */
		  background: transparent; /* Could be transparent or white */
		}

	  
      .progress-bar {
        height: 100%;
        background: #ffffff;
        border-radius: 2px;
        width: 0%;
        transition: width 0.3s ease-out, background 1s ease-out;
      }
      
      .tagline {
        color: #ffffff;
        font-size: 1.4rem;
        font-weight: 200;
        margin-bottom: 30px;
        transition: color 1s ease-out;
      }
      
      .progress-text {
        font-size: 3.2rem;
        color: #ffffff;
        font-weight: 300;
        margin-top: 20px;
        transition: color 1s ease-out;
      }
      
      /* Progressive loading states - adjusted to start transition at 60% */
      #custom-loading-screen.progress-60 {
        background: #555555;
      }
      
      #custom-loading-screen.progress-60 .tagline,
      #custom-loading-screen.progress-60 .progress-text {
        color: #f0f0f0;
      }
      
      #custom-loading-screen.progress-60 .progress-bar {
        background: #f0f0f0;
      }
      
      #custom-loading-screen.progress-75 {
        background: #aaaaaa;
      }
      
      #custom-loading-screen.progress-75 .tagline,
      #custom-loading-screen.progress-75 .progress-text {
        color: #333333;
      }
      
      #custom-loading-screen.progress-75 .progress-container {
        background: rgba(50, 50, 50, 0.2);
      }
      
      #custom-loading-screen.progress-75 .progress-bar {
        background: #333333;
      }
      
      #custom-loading-screen.progress-100 {
        background: #ffffff;
      }
      
      #custom-loading-screen.progress-100 .tagline,
      #custom-loading-screen.progress-100 .progress-text {
        color: #000000;
      }
      
      #custom-loading-screen.progress-100 .progress-container {
        background: rgba(0, 0, 0, 0.1);
      }
      
      #custom-loading-screen.progress-100 .progress-bar {
        background: #000000;
      }
      
      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .logo-container img {
          max-width: 200px;
        }
        
        .tagline {
          font-size: 1.5rem;
        }
        
        .progress-text {
          font-size: 1.8rem;
        }
        
        .loading-content {
          width: 85%;
        }
      }
    </style>
    
    <!-- PlayerPrefs hardcore fix that must run before anything else -->
    <script>
      // Intercept and fix localStorage and PlayerPrefs storage before Unity loads
      (function() {
        // Create a fake Promise-like localStorage with then() method
        var promiseLocalStorage = {
          _data: {},
          getItem: function(key) { 
            return this._data[key] || null; 
          },
          setItem: function(key, value) { 
            this._data[key] = String(value); 
            return value;
          },
          removeItem: function(key) { 
            delete this._data[key]; 
          },
          clear: function() { 
            this._data = {}; 
          },
          then: function(callback) { 
            // Make it act like a Promise
            callback(this);
            return this;
          },
          catch: function(callback) { 
            // Make it act like a Promise
            return this;
          }
        };

        // Define all possible functions that Unity might use
        window.getUserConfig = function() { return promiseLocalStorage; };
        window._GetUserConfig = function() { return promiseLocalStorage; };
        window.GetUserConfig = function() { return promiseLocalStorage; };
        window.testUserConfigStorage = function() { return promiseLocalStorage; };
        
        // Override default localStorage as well
        try {
          // Test if localStorage is available
          window.localStorage.getItem("test");
        } catch (e) {
          // Replace localStorage if not available
          window.localStorage = promiseLocalStorage;
        }
        
        console.log("Advanced PlayerPrefs polyfill installed");
      })();
      
      // Disable Service Worker to prevent any conflicts
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            registration.unregister();
            console.log('ServiceWorker unregistered');
          }
        });
      }
    </script>
  </head>
  <body>
    <!-- Custom Beautiful Loading Screen -->
    <div id="custom-loading-screen">
      <div class="loading-content">
        <div class="logo-container">
          <img src="Papadatos_logo_white.png" alt="Papadatos Logo" id="logo-image">
        </div>
        
        <div class="progress-section">
          <div class="progress-container">
			<div class="progress-line left"></div>
			<div class="progress-line-middle"></div>
			<div class="progress-line right"></div>
          </div>
          <div class="tagline">Configure Your Vision</div>
          <div class="progress-text" id="progress-text">%10</div>
        </div>
      </div>
    </div>

    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"> </div>
    </div>
    
    <script>
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var warningBanner = document.querySelector("#unity-warning");

      // Custom loading screen elements
      var customLoadingScreen = document.querySelector("#custom-loading-screen");
      var customProgressBar = document.querySelector("#custom-progress-bar");
      var progressText = document.querySelector("#progress-text");

      // Function to update loading screen appearance based on progress
		function updateLoadingScreenProgress(percentage) {
        // Remove existing progress classes
		customLoadingScreen.classList.remove('progress-60', 'progress-75', 'progress-100');
        
		  // Add appropriate progress class based on percentage
		  if (percentage >= 100) {
			customLoadingScreen.classList.add('progress-100');
			document.getElementById('logo-image').src = "Papadatos_logo_black.png";
		  } else if (percentage >= 75) {
			customLoadingScreen.classList.add('progress-75');
			document.getElementById('logo-image').src = "Papadatos_logo_black.png";
		  } else if (percentage >= 60) {
			customLoadingScreen.classList.add('progress-60');
			document.getElementById('logo-image').src = "Papadatos_logo_black.png";
		  }
		}

		// Update the references to the progress elements
		var progressLineLeft = document.querySelector(".progress-line.left");
		var progressLineRight = document.querySelector(".progress-line.right");

		function updateProgressLines(percentage) {
		  // For 100% progress, we want the lines to be exactly 50% wide each
		  // and meet in the middle with no gap
		  if (percentage >= 100) {
			progressLineLeft.style.width = '50%';
			progressLineRight.style.width = '50%';
			document.querySelector(".progress-line-middle").style.width = '0%';
			return;
		  }
		  
		  // For progress less than 100%, calculate proportional width
		  // This ensures the lines grow gradually until they meet
		  var lineWidth = (percentage / 2) + '%';
		  
		  // Update both lines
		  progressLineLeft.style.width = lineWidth;
		  progressLineRight.style.width = lineWidth;
		  
		  // Keep the middle gap proportional
		  var middleWidth = (100 - percentage) + '%';
		  document.querySelector(".progress-line-middle").style.width = middleWidth;
		}

      // Shows a temporary message banner/ribbon for a few seconds, or
      // a permanent error message on top of the canvas if type=='error'.
      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/WebGL_Build.loader.js";
      var config = {
        dataUrl: buildUrl + "/WebGL_Build.data",
        frameworkUrl: buildUrl + "/WebGL_Build.framework.js",
        codeUrl: buildUrl + "/WebGL_Build.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Saltvision",
        productName: "Papadatos 3D Configurator",
        productVersion: "1.0",
        showBanner: unityShowBanner,
      };

      // Mobile device detection and viewport setup
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
        container.className = "unity-mobile";
        canvas.className = "unity-mobile";
        
        unityShowBanner('WebGL builds are not supported on mobile devices.');
      } else {
        // Desktop style: Responsive canvas that fills available space
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        
        // Set container to fill viewport
        container.style.width = "100vw";
        container.style.height = "100vh";
        container.style.margin = "0";
        container.style.padding = "0";
      }

      // Create a mock loading process for testing if Unity build is not available
      function mockLoading() {
        var mockPercentage = 0;
        var mockInterval = setInterval(function() {
          mockPercentage += 1;
          

          progressText.textContent = "%" + mockPercentage;
          
          updateLoadingScreenProgress(mockPercentage);
	    	updateProgressLines(mockPercentage);

          
          if (mockPercentage >= 100) {
            clearInterval(mockInterval);
            
            // Hide the custom loading screen with a smooth transition
            setTimeout(function() {
              customLoadingScreen.classList.add('hidden');
              // Remove the loading screen from DOM after transition
              setTimeout(function() {
                customLoadingScreen.remove();
              }, 500);
            }, 1000);
          }
        }, 50);
      }

      // Check if we should use mock loading for testing
      var urlParams = new URLSearchParams(window.location.search);
      var useMock = urlParams.get('mock') === 'true';
      
      if (useMock) {
        console.log("Using mock loading for testing");
        mockLoading();
      } else {
        // Actual Unity loading
        var script = document.createElement("script");
        script.src = loaderUrl;
        
        // Handle script loading errors
		script.onerror = function() {
		  console.error("Failed to load Unity loader script. Falling back to mock loading for demonstration.");
		  progressText.textContent = "Using demo mode";
		  // Use a fixed percentage or remove this line since mockLoading will handle it
		  updateProgressLines(10); // Starting percentage

		  setTimeout(function() {
			mockLoading();
		  }, 1000);
		};        
        script.onload = function() {
          var unityLoader = function() {
            try {
			createUnityInstance(canvas, config, function(progress) {
			  // Update our beautiful custom progress bar
			  var percentage = Math.round(progress * 100);
			  progressText.textContent = "%" + percentage;
			  
			  // Update the loading screen appearance based on progress
			  updateLoadingScreenProgress(percentage);
			  // Add this line to update the progress lines!
			  updateProgressLines(percentage);
			  
			  console.log("Loading progress: " + percentage + "%");
                
                // Force completion at 90% since we know it gets stuck there
                if (percentage >= 90) {
                  console.log("Loading appears to be stuck at 90%, forcing completion...");
                  
                  // Give it a moment to see if it progresses naturally
                  setTimeout(function() {
                    var currentPercentage = parseInt(progressText.textContent.replace('%', ''));
                    if (currentPercentage >= 90 && currentPercentage < 100) {
                      // Still stuck at or above 90%, force to 100%
                      progressText.textContent = "%100";
                      updateLoadingScreenProgress(100);
                      
                      // Hide the custom loading screen with a smooth transition
                      setTimeout(function() {
                        customLoadingScreen.classList.add('hidden');
                        // Remove the loading screen from DOM after transition
                        setTimeout(function() {
                          customLoadingScreen.remove();
                        }, 500);
                      }, 1000);
                    }
                  }, 3000); // Wait 3 seconds to see if it completes naturally
                }
              }).then(function(unityInstance) {
				// Ensure we show the final 100% state briefly
				updateLoadingScreenProgress(100);
				progressText.textContent = "%100";
                
                // Hide the custom loading screen with a smooth transition
                setTimeout(function() {
                  customLoadingScreen.classList.add('hidden');
                  // Remove the loading screen from DOM after transition
                  setTimeout(function() {
                    customLoadingScreen.remove();
                  }, 500);
                }, 1000); // Small delay to show 100% briefly
                
                // Store the unityInstance for global access
                window.unityInstance = unityInstance;
                
                // Check if there's a configuration ID in the URL
                var configId = urlParams.get('id');
                if (configId) {
                  console.log("Found configuration ID in URL: " + configId);
                  // Send to JSONBin system instead of Firebase
                  if (unityInstance.SendMessage) {
                    // Try different possible SceneManager names
                    try {
                      unityInstance.SendMessage('SceneManager', 'TestLoadConfiguration', configId);
                    } catch (e) {
                      console.log("SceneManager not found, trying other methods...");
                    }
                  }
                }
              }).catch(function(message) {
                console.error("Unity error: ", message);
                // Update loading screen to show error
                progressText.textContent = "Using demo mode";
                
                // Fall back to mock loading for demonstration
                setTimeout(function() {
                  mockLoading();
                }, 2000);
              });
            } catch (e) {
              console.error("Error initializing Unity:", e);
              mockLoading();
            }
          };
          
          // Execute the Unity loader with a slight delay to ensure everything is ready
          setTimeout(unityLoader, 500);
        };

        document.body.appendChild(script);
      }
    </script>

    <!-- JSONBin Integration Functions -->
    <script>
      // Function to copy text to clipboard (for your save/share functionality)
      window.CopyToClipboardJS = function(text) {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text).then(function() {
            console.log('Text copied to clipboard successfully');
            // Notify Unity if needed
            if (window.unityInstance && window.unityInstance.SendMessage) {
              try {
                window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardCopySuccess', text);
              } catch (e) {
                // Try alternative callback names
                try {
                  window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardSuccess', text);
                } catch (e2) {
                  console.log('Unity clipboard callback not found, but copy was successful');
                }
              }
            }
          }).catch(function(err) {
            console.error('Failed to copy text to clipboard:', err);
            // Fallback method
            fallbackCopyTextToClipboard(text);
          });
        } else {
          // Fallback for older browsers
          fallbackCopyTextToClipboard(text);
        }
      };

      function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        
        // Avoid scrolling to bottom
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          var successful = document.execCommand('copy');
          if (successful) {
            console.log('Text copied to clipboard using fallback method');
            if (window.unityInstance && window.unityInstance.SendMessage) {
              try {
                window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardCopySuccess', text);
              } catch (e) {
                try {
                  window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardSuccess', text);
                } catch (e2) {
                  console.log('Unity clipboard callback not found, but copy was successful');
                }
              }
            }
          } else {
            console.error('Fallback copy to clipboard failed');
            if (window.unityInstance && window.unityInstance.SendMessage) {
              try {
                window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardCopyFailed', 'Copy command failed');
              } catch (e) {
                try {
                  window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardFailed', 'Copy command failed');
                } catch (e2) {
                  console.log('Unity clipboard error callback not found');
                }
              }
            }
          }
        } catch (err) {
          console.error('Fallback copy to clipboard failed:', err);
          if (window.unityInstance && window.unityInstance.SendMessage) {
            try {
              window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardCopyFailed', err.toString());
            } catch (e) {
              try {
                window.unityInstance.SendMessage('JSONBinUIController', 'OnClipboardFailed', err.toString());
              } catch (e2) {
                console.log('Unity clipboard error callback not found');
              }
            }
          }
        }

        document.body.removeChild(textArea);
      }

      // Function to open invoice in new window (for your invoice functionality)
      window.OpenInvoiceInNewWindow = function(htmlContent) {
        var newWindow = window.open('', '_blank');
        if (newWindow) {
          newWindow.document.write(htmlContent);
          newWindow.document.close();
          console.log('Invoice opened in new window');
        } else {
          console.error('Failed to open new window - popup blocked?');
          alert('Please allow popups for this site to view the invoice.');
        }
      };

      // Function to save screenshot (for your screenshot functionality)
      window.SaveScreenshot = function(base64Image, fileName) {
        try {
          // Convert base64 to blob
          var byteCharacters = atob(base64Image);
          var byteNumbers = new Array(byteCharacters.length);
          for (var i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          var byteArray = new Uint8Array(byteNumbers);
          var blob = new Blob([byteArray], {type: 'image/png'});

          // Create download link
          var link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = fileName + '.png';
          
          // Trigger download
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Clean up
          URL.revokeObjectURL(link.href);
          
          console.log('Screenshot saved:', fileName);
        } catch (error) {
          console.error('Error saving screenshot:', error);
        }
      };
    </script>
    
    <!-- Final fallback fix for any remaining getUserConfig/localStorage issues -->
    <script>
      // One more emergency fix for getUserConfig() trying to use then()
      if (typeof window.getUserConfig !== 'function' || 
          typeof window.getUserConfig().then !== 'function') {
        
        console.log("Applying emergency getUserConfig fix");
        
        var promiseLocalStorageFallback = {
          _data: {},
          getItem: function(key) { return this._data[key] || null; },
          setItem: function(key, value) { this._data[key] = String(value); return value; },
          removeItem: function(key) { delete this._data[key]; },
          clear: function() { this._data = {}; },
          then: function(callback) { callback(this); return this; },
          catch: function(callback) { return this; }
        };
        
        window.getUserConfig = function() { return promiseLocalStorageFallback; };
        window._GetUserConfig = function() { return promiseLocalStorageFallback; };
      }
    </script>
  </body>
</html>
